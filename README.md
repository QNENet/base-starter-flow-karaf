# Base Starter for Vaadin Flow and Karaf in NPM mode

This project can be used as a starting point to create your own Vaadin Flow application bundle for Karaf.
It has the necessary dependencies and files to help you get started.
**This project has been revised for Vaadin 19 (GA in March 2021) which brings back OSGi support in npm mode.
For now, it Vaadin OSGi support is only for Flow based views (Java UIs), but not for Fusion (TypeScript UIs).**

For more Vaadin usage samples, you can go to vaadin.com/start.

To access it directly from github, clone the repository and import the project to the IDE of your choice as a Maven project. You need to have Java 8 or 11 installed.


## Build and run a Vaadin web application OSGi bundle
The simplest way to start the project is run command `mvn install -Prun`.
This command build the starter project and run it in Karaf.

Note that it needs some time to deploy and start all the features so it may take some time when the URL 
http://localhost:8181 starts to work.

The command `mvn install` may be used to only build the project without running Karaf.
This command also builds a Karaf feature "project-base-karaf" which contains all the 
required bundles/dependencies to be able to start the project bundle.

If you have a Karaf container already installed then you may install and run the project 
via Karaf interactive shell:

```
./bin/karaf // starts interactive Karaf shell
karaf@root()> feature:install http
karaf@root()> feature:install war  // this and above commands starts PAX-web Http Whiteboard implementation
karaf@root()> feature:repo-add mvn:com.example/project-base-karaf/1.0-SNAPSHOT/xml/features //adds project-base feature repository generated by maven plugin
karaf@root()> feature:install project-base-karaf // installs and starts project feature
```

Once the commands are completed (it may take some time) open the URL http://localhost:8181 in your browser.

## Servlet configuration

Vaadin Servlet initial parameters may be passed via `@Component` annotation parameter `property`, e.g.

```java
@Component(immediate = false, service = Servlet.class, property = {
  HttpWhiteboardConstants.HTTP_WHITEBOARD_SERVLET_INIT_PARAM_PREFIX +
  InitParameters.SERVLET_PARAMETER_PRODUCTION_MODE + "=false"})
```
or via some annotation like `VaadinMode` which is available in the example.

Another way to set the `productionMode` value is explicitly set it via the Vaadin maven plugin configuration:

```xml
 <configuration>
    <productionMode>false</productionMode>
</configuration>

```

The values will be set in the token file (`flow-build-info.json`) which is read to 
create a deployment configuration for a Vaadin servlet.

Note: Not any property can be set via Vaadin maven plugin configuration.
There is a limited number of Maven configuration parameters which are reflected to the same Vaadin Servlet init property name.
`productionMode` is mapped exactly as is: the same name is init parameter and the same maven config parameter can be used in the pom.xml.
There are config Maven parameters which have different names comparing to init parameters.
And there are a lot of Vaadin Servlet init parameters (see `com.vaadin.flow.server.InitParameters`) and only few Maven configuration parameters (see `com.vaadin.flow.plugin.maven.FlowModeAbstractMojo`).

## Vaadin Servlet registration in OSGi

At the moment Flow doesn't provide automatic servlet registration so servlet needs to be 
registered manually in the web application project. The example how to do it is 
provided in the project (see `FixedVaadinServlet`). 

PAX-web Http Whiteboard implementation which is used usually in Karaf has some issues related to
`ServletContextListener` service support. To be able to avoid these issues `OSGiVaadinServlet` class should
be used as a super class for the servlet registered as a service in Karaf.


## Limitations

Here is a list of things which are not currently supported:

- NPM dev mode: it's possible to run Vaadin web application in both production 
and dev mode, but dev mode can be used only with precompiled frontend
 resources (via vaadin-maven-plugin) and it's not possible to use a dev server (Webpack) within OSGi.
- it's not possible to use OSGi declarative services with Vaadin components: 
you may not inject a service declaratively in Vaadin classes (using annotations) 
just because UI objects are not managed by OSGi. But you still may call OSGi services programmatically of course.
- as mentioned above: there is no yet automatic servlet registration. So the web application 
bundle should register the servlet itself.
- there is no documentation and it's not clear how to make Push working with WebSockets: the main question 
here is enabling WS on pure OSGi container. It works on hybrid OSGi container which allows
to deploy WARs (like Karaf) but this is exactly the same as for plain web server. It's not clear what
needs to be done to enable WS for a pure OSGi container.


## Deploying Vaadin specific bundles to an OSGi container

Vaadin application generally contains dependencies to other bundles: e.g. Vaadin components like `Button`,
`TextField` , etc. Every Vaadin component is based on a Web Component which
is represented by frontend resources. All frontend resources are built into a bundle
along with Vaadin WAB. As a result:
- any Vaadin component bundle update is possible only within the same minor version, 
so that the Web Component version stays the same (and only Java code is updated). We don't recommend 
updating any version over a minor for Flow or the web component Flow integrations (even though it's
not prevented anyhow at the moment).
- Updating any bundle that has frontend resources requires that the frontend build goal `build-frontend` 
is run and the WAB is redeployed to get the static frontend bundle updated.
